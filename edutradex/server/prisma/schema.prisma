// ========================================
// PostgreSQL Production Schema
// ========================================
// To use this schema for production:
// 1. Backup your current schema.prisma
// 2. Replace schema.prisma with this file
// 3. Run: npx prisma migrate deploy

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String       @id @default(uuid())
  email             String       @unique
  password          String
  name              String
  role              String       @default("USER") // "USER", "ADMIN", "SUPERADMIN"
  liveBalance       Float        @default(0)
  demoBalance       Float        @default(0)        // NOTE: This is actually the REAL money balance (legacy naming)
  practiceBalance   Float        @default(10000)    // Demo/practice balance for risk-free trading
  activeAccountType String       @default("LIVE")   // "LIVE" uses demoBalance, "DEMO" uses practiceBalance
  isActive          Boolean      @default(true)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  trades            Trade[]
  sessions          Session[]
  deposits          Deposit[]
  withdrawals       Withdrawal[]

  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?

  kyc             KYC?
  supportTickets  SupportTicket[]

  leaderProfile CopyTradingLeader?
  following     CopyTradingFollower[] @relation("Follower")

  referralCode      String?   @unique
  referredBy        String?
  referredByUser    User?     @relation("Referrals", fields: [referredBy], references: [id])
  referrals         User[]    @relation("Referrals")
  referralEarnings  Float     @default(0)
  totalReferrals    Int       @default(0)

  commissionsEarned  ReferralCommission[] @relation("Earner")
  commissionsGenerated ReferralCommission[] @relation("Generator")

  // OTC Manual Control relations
  otcManualInterventions OTCManualIntervention[]
  otcUserTargetings      OTCUserTargeting[]

  // SuperAdmin tracking fields
  lastLoginAt       DateTime?
  lastLoginIp       String?
  loginCount        Int       @default(0)
  isProtected       Boolean   @default(false) // Protected users cannot be deleted/demoted

  // SuperAdmin audit relations
  adminActivities   AdminActivityLog[] @relation("AdminActivities")
  adminSessions     AdminSession[]     @relation("AdminSessions")

  // Security tracking fields (for ALL users)
  registrationIp        String?
  registrationCountry   String?
  registrationUserAgent String?
  registrationDeviceId  String?
  lastKnownCountry      String?
  failedLoginAttempts   Int       @default(0)
  lockedUntil           DateTime?
  lockReason            String?

  // Security relations
  devices               UserDevice[]
  loginAttempts         LoginAttempt[]
  riskProfile           UserRiskProfile?
  securityAlerts        SecurityAlert[]

  // Two-Factor Authentication
  twoFactorEnabled      Boolean      @default(false)
  twoFactorSecret       String?      // Encrypted TOTP secret
  twoFactorVerifiedAt   DateTime?    // When 2FA was last verified
  backupCodes           String[]     @default([]) // Hashed backup codes

  @@index([email])
  @@index([role])
  @@index([referralCode])
  @@index([referredBy])
  @@index([emailVerified])
  @@index([role, isActive])
  @@index([isActive])
}

model Trade {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  market        String
  symbol        String
  direction     String
  amount        Float
  entryPrice    Float
  exitPrice     Float?
  duration      Int
  payoutPercent Float
  status        String    @default("OPEN")
  result        String?
  profit        Float?
  accountType   String    @default("DEMO")
  openedAt      DateTime  @default(now())
  closedAt      DateTime?
  expiresAt     DateTime

  isCopyTrade      Boolean           @default(false)
  originalTrades   CopiedTrade[]     @relation("OriginalTrade")
  copiedFromTrades CopiedTrade[]     @relation("CopiedTrade")
  pendingCopies    PendingCopyTrade[]

  @@index([userId])
  @@index([status])
  @@index([symbol])
  @@index([openedAt])
  @@index([accountType])
  @@index([userId, status])
  @@index([userId, status, result])
  @@index([userId, openedAt])
  @@index([status, result])
  @@index([closedAt])
  // Composite index for scheduler query: WHERE status = 'OPEN' AND expiresAt <= NOW()
  @@index([status, expiresAt], name: "idx_trade_status_expires")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model MarketConfig {
  id             String   @id @default(uuid())
  symbol         String   @unique
  marketType     String
  name           String
  isActive       Boolean  @default(true)
  payoutPercent  Float    @default(80)
  minTradeAmount Float    @default(1)
  maxTradeAmount Float    @default(1000)
  volatilityMode String   @default("MEDIUM")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([symbol])
  @@index([marketType])
}

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

model Deposit {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount          Float
  method          String
  status          String    @default("PENDING")

  phoneNumber     String?
  mobileProvider  String?

  cryptoCurrency  String?
  walletAddress   String?
  transactionHash String?

  adminNote       String?
  processedBy     String?
  processedAt     DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([method])
  @@index([createdAt])
  @@index([status, method])
  @@index([userId, status])
}

model SpreadConfig {
  id           String   @id @default(uuid())
  symbol       String   @unique
  markupPips   Float    @default(2)
  isActive     Boolean  @default(true)
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([symbol])
  @@index([isActive])
}

model Withdrawal {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount          Float
  method          String
  status          String    @default("PENDING")

  phoneNumber     String?
  mobileProvider  String?

  cryptoCurrency  String?
  walletAddress   String?
  network         String?

  adminNote       String?
  processedBy     String?
  processedAt     DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([method])
  @@index([createdAt])
  @@index([status, method])
  @@index([userId, status])
}

model PaymentMethod {
  id              String   @id @default(uuid())
  type            String
  name            String
  code            String   @unique

  cryptoCurrency  String?
  network         String?
  walletAddress   String?

  mobileProvider  String?
  phoneNumber     String?
  accountName     String?

  iconUrl         String?
  iconBg          String   @default("bg-gray-500/20")
  displayOrder    Int      @default(0)

  minAmount       Float    @default(10)
  maxAmount       Float    @default(10000)
  processingTime  String   @default("~5 min")

  isActive        Boolean  @default(true)
  isPopular       Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type])
  @@index([isActive])
  @@index([displayOrder])
}

model CopyTradingLeader {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName String
  description String?
  avatarUrl   String?

  status      String   @default("PENDING")

  totalTrades   Int    @default(0)
  winningTrades Int    @default(0)
  totalProfit   Float  @default(0)
  winRate       Float  @default(0)

  maxFollowers Int     @default(100)
  isPublic     Boolean @default(true)

  adminNote    String?
  approvedAt   DateTime?
  rejectedAt   DateTime?
  suspendedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  followers    CopyTradingFollower[]
  copiedTrades CopiedTrade[]

  @@index([userId])
  @@index([status])
  @@index([winRate])
  @@index([totalTrades])
}

model CopyTradingFollower {
  id         String            @id @default(uuid())
  followerId String
  follower   User              @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  leaderId   String
  leader     CopyTradingLeader @relation(fields: [leaderId], references: [id], onDelete: Cascade)

  // Mode: "PERCENTAGE" or "FIXED_AMOUNT"
  copyMode         String  @default("PERCENTAGE")

  // For PERCENTAGE mode - percentage of leader's trade amount (e.g., 50, 100, 150)
  percentageAmount Float   @default(100)

  // For FIXED_AMOUNT mode - fixed $ amount per trade
  fixedAmount      Float   @default(10)

  // For FIXED_AMOUNT mode - daily limits (null = no limit)
  dailyLossLimit   Float?
  dailyProfitLimit Float?

  // Daily tracking counters (reset daily)
  dailyLoss        Float   @default(0)
  dailyProfit      Float   @default(0)

  // Max trades per day (null when unlimitedTrades is true)
  maxDailyTrades   Int?    @default(50)
  unlimitedTrades  Boolean @default(false)

  isActive         Boolean @default(true)

  tradesToday    Int      @default(0)
  lastTradeDate  DateTime?

  totalCopied Int   @default(0)
  totalProfit Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  copiedTrades  CopiedTrade[]
  pendingTrades PendingCopyTrade[]

  @@unique([followerId, leaderId])
  @@index([followerId])
  @@index([leaderId])
  @@index([isActive])
  @@index([leaderId, isActive])
}

model CopiedTrade {
  id         String              @id @default(uuid())
  followerId String
  follower   CopyTradingFollower @relation(fields: [followerId], references: [id], onDelete: Cascade)
  leaderId   String
  leader     CopyTradingLeader   @relation(fields: [leaderId], references: [id], onDelete: Cascade)

  originalTradeId String
  originalTrade   Trade  @relation("OriginalTrade", fields: [originalTradeId], references: [id])
  copiedTradeId   String
  copiedTrade     Trade  @relation("CopiedTrade", fields: [copiedTradeId], references: [id])

  amount Float
  profit Float?

  createdAt DateTime @default(now())

  @@index([followerId])
  @@index([leaderId])
  @@index([originalTradeId])
  @@index([copiedTradeId])
}

model PendingCopyTrade {
  id          String              @id @default(uuid())
  followerId  String
  followerRel CopyTradingFollower @relation(fields: [followerId], references: [id], onDelete: Cascade)

  originalTradeId String
  originalTrade   Trade  @relation(fields: [originalTradeId], references: [id])

  symbol          String
  direction       String
  suggestedAmount Float
  entryPrice      Float
  duration        Int
  market          String

  status    String   @default("PENDING")
  expiresAt DateTime

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([followerId])
  @@index([status])
  @@index([expiresAt])
  // Composite index for expiry queries: WHERE status = 'PENDING' AND expiresAt < NOW()
  @@index([status, expiresAt], name: "idx_pending_copy_status_expires")
}

model ReferralCommission {
  id            String   @id @default(uuid())

  earnerId      String
  earner        User     @relation("Earner", fields: [earnerId], references: [id], onDelete: Cascade)

  generatorId   String
  generator     User     @relation("Generator", fields: [generatorId], references: [id], onDelete: Cascade)

  type          String
  amount        Float
  percentage    Float
  sourceAmount  Float?
  sourceId      String?

  status        String   @default("PENDING")
  creditedAt    DateTime?

  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([earnerId])
  @@index([generatorId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([earnerId, status])
  @@index([earnerId, generatorId, status])
  @@index([generatorId, earnerId])
}

model ReferralSettings {
  id                    String   @id @default(uuid())

  signupBonus           Float    @default(5)
  depositCommission     Float    @default(5)
  tradeCommission       Float    @default(1)

  minWithdrawal         Float    @default(10)
  maxCommissionPerUser  Float    @default(1000)

  isActive              Boolean  @default(true)
  requireVerification   Boolean  @default(false)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model EmailVerification {
  id        String   @id @default(uuid())
  email     String
  code      String
  type      String   @default("SIGNUP")
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([code])
  @@index([expiresAt])
}

model AdminMessage {
  id          String   @id @default(uuid())
  senderId    String
  recipientId String?
  subject     String
  content     String
  type        String   @default("GENERAL")
  isRead      Boolean  @default(false)
  sentViaEmail Boolean @default(true)
  createdAt   DateTime @default(now())

  @@index([recipientId])
  @@index([senderId])
  @@index([createdAt])
}

model KYC {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName       String?
  lastName        String?
  dateOfBirth     DateTime?
  nationality     String?
  address         String?
  city            String?
  country         String?
  postalCode      String?
  phoneNumber     String?

  documentType    String?
  documentNumber  String?
  documentFront   String?
  documentBack    String?
  selfieWithId    String?

  status          String    @default("NOT_SUBMITTED")
  rejectionReason String?

  reviewedBy      String?
  reviewedAt      DateTime?
  adminNote       String?

  submittedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([status])
}

model SupportTicket {
  id          String   @id @default(uuid())

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  ticketNumber String  @unique
  subject     String
  message     String
  category    String   @default("GENERAL")
  priority    String   @default("MEDIUM")
  status      String   @default("OPEN")

  adminReply  String?
  repliedBy   String?
  repliedAt   DateTime?

  closedBy    String?
  closedAt    DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([priority, status])
  @@index([ticketNumber])
  @@index([createdAt])
}

model SimulatedLeader {
  id              String   @id @default(uuid())

  displayName     String
  description     String?
  avatarUrl       String?

  winRate         Float    @default(65)
  totalProfit     Float    @default(1000)
  totalTrades     Int      @default(100)
  followerCount   Int      @default(50)

  // Variation settings for dynamic updates
  winRateMin      Float    @default(60)
  winRateMax      Float    @default(85)
  profitMin       Float    @default(500)
  profitMax       Float    @default(10000)
  followerMin     Int      @default(20)
  followerMax     Int      @default(500)
  tradesMin       Int      @default(50)
  tradesMax       Int      @default(1000)

  // Activity simulation settings
  tradeFrequency  Int      @default(5)  // trades per hour (simulated)

  isActive        Boolean  @default(true)
  displayOrder    Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Real followers tracking
  followers       SimulatedLeaderFollower[]

  @@index([isActive])
  @@index([displayOrder])
}

// Track users following simulated leaders (visual only, no real trades)
model SimulatedLeaderFollower {
  id                  String          @id @default(uuid())

  userId              String
  simulatedLeaderId   String
  simulatedLeader     SimulatedLeader @relation(fields: [simulatedLeaderId], references: [id], onDelete: Cascade)

  // Copy settings (display only, no real trades)
  // Mode: "PERCENTAGE" or "FIXED_AMOUNT"
  copyMode            String          @default("PERCENTAGE")

  // For PERCENTAGE mode - percentage of leader's trade amount
  percentageAmount    Float           @default(100)

  // For FIXED_AMOUNT mode - fixed $ amount per trade
  fixedAmount         Float           @default(10)

  // For FIXED_AMOUNT mode - daily limits (null = no limit)
  dailyLossLimit      Float?
  dailyProfitLimit    Float?

  // Max trades per day (null when unlimitedTrades is true)
  maxDailyTrades      Int?            @default(50)
  unlimitedTrades     Boolean         @default(false)

  isActive            Boolean         @default(true)

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@unique([userId, simulatedLeaderId])
  @@index([userId])
  @@index([simulatedLeaderId])
  @@index([isActive])
}

// ==========================================
// OTC MARKET SYSTEM
// ==========================================

// OTC Configuration per symbol - Admin configurable
model OTCConfig {
  id                      String   @id @default(uuid())
  symbol                  String   @unique  // e.g., "EUR/USD-OTC"
  baseSymbol              String   // e.g., "EUR/USD" (real symbol to track)
  marketType              String   // "FOREX" or "CRYPTO"
  name                    String   // Display name
  isEnabled               Boolean  @default(true)

  // Price Generation Settings
  baseVolatility          Float    @default(0.0003)   // Base volatility per tick (0.03%)
  volatilityMultiplier    Float    @default(1.0)      // Scale volatility up/down
  meanReversionStrength   Float    @default(0.0015)   // How fast price reverts to real
  maxDeviationPercent     Float    @default(1.5)      // Max allowed deviation from real price
  priceOffsetPips         Float    @default(2.0)      // Small offset from real price
  momentumFactor          Float    @default(0.15)     // Trend continuation strength

  // Volatility Clustering (GARCH parameters)
  garchAlpha              Float    @default(0.08)     // Weight of recent shocks
  garchBeta               Float    @default(0.88)     // Persistence of volatility
  garchOmega              Float    @default(0.04)     // Long-term variance weight

  // Risk Management Settings
  riskEnabled             Boolean  @default(true)
  exposureThreshold       Float    @default(0.35)     // 35% imbalance triggers review
  minInterventionRate     Float    @default(0.25)     // 25% minimum intervention
  maxInterventionRate     Float    @default(0.40)     // 40% maximum intervention (moderate)
  spreadMultiplier        Float    @default(1.5)      // Max spread multiplier for adjustments

  // Trading Settings
  payoutPercent           Float    @default(85)
  minTradeAmount          Float    @default(1)
  maxTradeAmount          Float    @default(1000)
  pipSize                 Float    @default(0.0001)   // Price precision

  // Scheduling
  is24Hours               Boolean  @default(true)     // OTC runs 24/7
  anchoringDurationMins   Int      @default(15)       // Minutes to anchor after market opens

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  priceHistory            OTCPriceHistory[]
  exposure                OTCRiskExposure?
  activityLogs            OTCActivityLog[]

  @@index([baseSymbol])
  @@index([marketType])
  @@index([isEnabled])
  @@index([marketType, isEnabled])
}

// OTC Price History - For charts and analysis
model OTCPriceHistory {
  id          String    @id @default(uuid())
  configId    String
  config      OTCConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  symbol      String    // OTC symbol for quick lookup
  price       Float
  bid         Float
  ask         Float

  // OHLC data for candle generation
  open        Float?
  high        Float?
  low         Float?
  close       Float?
  volume      Int       @default(0)

  // Price mode tracking
  priceMode   String    @default("OTC")  // "REAL", "OTC", "ANCHORING"

  // Volatility state at this point
  volatilityState Float?

  timestamp   DateTime  @default(now())

  @@index([symbol, timestamp])
  @@index([configId, timestamp])
  @@index([symbol])
  @@index([timestamp])
}

// Real-time Risk Exposure per OTC symbol
model OTCRiskExposure {
  id                String    @id @default(uuid())
  configId          String    @unique
  config            OTCConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  symbol            String    @unique

  // UP direction exposure
  totalUpAmount     Float     @default(0)
  activeUpTrades    Int       @default(0)
  upTradeIds        String[]  // Array of trade IDs

  // DOWN direction exposure
  totalDownAmount   Float     @default(0)
  activeDownTrades  Int       @default(0)
  downTradeIds      String[]  // Array of trade IDs

  // Calculated metrics
  netExposure       Float     @default(0)    // UP - DOWN
  exposureRatio     Float     @default(0)    // Imbalance ratio 0-1
  brokerRiskAmount  Float     @default(0)    // Potential broker loss

  // Statistics
  totalInterventions    Int   @default(0)
  successfulInterventions Int @default(0)
  totalTradesProcessed  Int   @default(0)

  // Historical peak exposure
  peakExposureRatio Float     @default(0)
  peakExposureTime  DateTime?

  lastUpdated       DateTime  @updatedAt
  createdAt         DateTime  @default(now())

  // Individual trade tracking
  tradeExposures    OTCTradeExposure[]

  @@index([symbol])
  @@index([exposureRatio])
}

// Track individual trade contributions to exposure
model OTCTradeExposure {
  id            String           @id @default(uuid())
  exposureId    String
  exposure      OTCRiskExposure  @relation(fields: [exposureId], references: [id], onDelete: Cascade)

  tradeId       String           @unique
  symbol        String
  direction     String           // "UP" or "DOWN"
  amount        Float
  entryPrice    Float
  userId        String
  expiresAt     DateTime

  createdAt     DateTime         @default(now())

  @@index([exposureId])
  @@index([tradeId])
  @@index([symbol])
  @@index([expiresAt])
  @@index([userId])
}

// OTC Activity Log - Audit trail for all OTC operations
model OTCActivityLog {
  id              String    @id @default(uuid())
  configId        String?
  config          OTCConfig? @relation(fields: [configId], references: [id], onDelete: SetNull)

  symbol          String
  eventType       String    // Types: PRICE_GENERATED, MODE_SWITCH, TRADE_TRACKED, etc.

  // Event context
  tradeId         String?
  userId          String?

  // Metrics at time of event
  priceMode       String?
  exposureRatio   Float?
  interventionProbability Float?

  // Price data
  marketPrice     Float?
  adjustedPrice   Float?
  entryPrice      Float?

  // Additional details as JSON
  details         Json?

  // Outcome
  success         Boolean   @default(true)
  errorMessage    String?

  timestamp       DateTime  @default(now())

  @@index([symbol, timestamp])
  @@index([eventType])
  @@index([tradeId])
  @@index([userId])
  @@index([timestamp])
  @@index([symbol, eventType])
}

// ==========================================
// OTC MANUAL CONTROL SYSTEM
// ==========================================

// Audit trail for all manual interventions
model OTCManualIntervention {
  id            String   @id @default(uuid())
  adminId       String
  admin         User     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  actionType    String   // PRICE_BIAS, TRADE_FORCE, USER_TARGET, VOLATILITY, PRICE_OVERRIDE
  targetType    String   // SYMBOL, TRADE, USER
  targetId      String   // symbol name, tradeId, or userId

  previousValue Json?
  newValue      Json
  reason        String?

  createdAt     DateTime @default(now())

  @@index([actionType, createdAt(sort: Desc)])
  @@index([targetType, createdAt(sort: Desc)])
  @@index([targetId])
  @@index([adminId])
  @@index([createdAt(sort: Desc)])
}

// Active manual controls per symbol
model OTCManualControl {
  id                   String    @id @default(uuid())
  symbol               String    @unique

  // Price direction bias (-100 to +100, 0 = neutral)
  directionBias        Int       @default(0)
  directionStrength    Float     @default(0)  // 0-1 multiplier
  directionBiasExpiry  DateTime?  // null = permanent, otherwise auto-resets

  // Volatility override multiplier
  volatilityMultiplier Float     @default(1.0)
  volatilityExpiry     DateTime?  // null = permanent, otherwise auto-resets

  // Direct price override
  priceOverride        Float?
  priceOverrideExpiry  DateTime?

  isActive             Boolean   @default(true)
  updatedAt            DateTime  @updatedAt
  updatedBy            String?

  @@index([symbol])
  @@index([isActive])
}

// User-specific targeting for win rate manipulation
model OTCUserTargeting {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  symbol          String?  // null = applies to all OTC symbols

  // Win rate override (0-100, null = use normal algorithm)
  targetWinRate   Float?

  // Force next N trades outcome
  forceNextWin    Int      @default(0)
  forceNextLose   Int      @default(0)

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String   // Admin who created this targeting

  @@unique([userId, symbol])
  @@index([userId])
  @@index([isActive])
  @@index([symbol])
}

// ==========================================
// SUPERADMIN SYSTEM
// ==========================================

// Admin Activity Log - Audit trail for all admin/superadmin actions
model AdminActivityLog {
  id            String   @id @default(uuid())
  adminId       String
  admin         User     @relation("AdminActivities", fields: [adminId], references: [id], onDelete: Cascade)

  actionType    String   // LOGIN, LOGOUT, USER_CREATE, USER_UPDATE, USER_DELETE, USER_STATUS_CHANGE,
                         // ROLE_CHANGE, DEPOSIT_APPROVE, DEPOSIT_REJECT, WITHDRAWAL_APPROVE, WITHDRAWAL_REJECT,
                         // KYC_APPROVE, KYC_REJECT, SETTINGS_CHANGE, ADMIN_CREATE, ADMIN_UPDATE, ADMIN_DELETE,
                         // ADMIN_PASSWORD_RESET, ADMIN_ACTIVATE, ADMIN_DEACTIVATE, LEADER_APPROVE, LEADER_REJECT,
                         // LEADER_SUSPEND, OTC_CONFIG_CHANGE, MARKET_CONFIG_CHANGE, TICKET_REPLY, TICKET_CLOSE
  targetType    String?  // USER, DEPOSIT, WITHDRAWAL, SETTINGS, ADMIN, KYC, LEADER, TICKET, OTC, MARKET
  targetId      String?  // ID of the affected entity

  description   String   // Human-readable description
  previousValue Json?    // Previous state (for changes)
  newValue      Json?    // New state (for changes)

  ipAddress     String?
  userAgent     String?

  metadata      Json?    // Additional context data

  createdAt     DateTime @default(now())

  @@index([adminId])
  @@index([actionType])
  @@index([targetType])
  @@index([targetId])
  @@index([createdAt])
  @@index([adminId, createdAt])
  @@index([actionType, createdAt])
}

// Admin Session tracking for SuperAdmin monitoring
model AdminSession {
  id          String    @id @default(uuid())
  adminId     String
  admin       User      @relation("AdminSessions", fields: [adminId], references: [id], onDelete: Cascade)

  token       String    @unique
  ipAddress   String?
  userAgent   String?

  loginAt     DateTime  @default(now())
  logoutAt    DateTime?
  expiresAt   DateTime

  isActive    Boolean   @default(true)

  @@index([adminId])
  @@index([token])
  @@index([isActive])
  @@index([loginAt])
  @@index([adminId, isActive])
}

// ==========================================
// TOKEN SECURITY
// ==========================================

// Token Blacklist - For invalidating tokens before expiry
model TokenBlacklist {
  id          String    @id @default(uuid())
  tokenHash   String    @unique  // Hashed token (we don't store raw tokens) - @unique creates index automatically
  userId      String
  reason      String    // LOGOUT, SESSION_TERMINATED, SECURITY_BREACH, PASSWORD_CHANGED, IMPERSONATION_ENDED
  expiresAt   DateTime  // When the token would have expired anyway (for cleanup)
  createdAt   DateTime  @default(now())

  // Composite index for the most frequent query: WHERE tokenHash = ? AND expiresAt > NOW()
  // This allows PostgreSQL to use a single index scan instead of filtering
  @@index([tokenHash, expiresAt], name: "idx_token_blacklist_hash_expiry")
  @@index([userId])
  @@index([expiresAt])  // For cleanup queries: DELETE WHERE expiresAt < NOW()
}

// ==========================================
// DEVICE FINGERPRINTING & SECURITY
// ==========================================

// User devices - tracks all devices used by a user
model UserDevice {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Device fingerprint (hash of browser/device characteristics)
  fingerprint     String
  fingerprintHash String    // SHA256 hash for faster lookups

  // Device details
  deviceType      String    // desktop, mobile, tablet
  browser         String?
  browserVersion  String?
  os              String?
  osVersion       String?
  screenResolution String?
  timezone        String?
  language        String?

  // Trust status
  isTrusted       Boolean   @default(false)
  trustScore      Int       @default(50) // 0-100
  trustedAt       DateTime?
  trustedBy       String?   // admin who trusted, or 'USER' if self-trusted

  // Usage tracking
  firstSeenAt     DateTime  @default(now())
  lastSeenAt      DateTime  @default(now())
  lastIp          String?
  lastCountry     String?
  loginCount      Int       @default(1)

  // Risk flags
  isBlocked       Boolean   @default(false)
  blockReason     String?
  blockedAt       DateTime?

  // Relations
  loginAttempts   LoginAttempt[]

  @@unique([userId, fingerprintHash])
  @@index([userId])
  @@index([fingerprintHash])
  @@index([fingerprint])
  @@index([isTrusted])
  @@index([isBlocked])
  @@index([lastSeenAt])                    // Device cleanup queries
  @@index([lastSeenAt, isTrusted])         // Cleanup old untrusted devices
}

// Login attempts - tracks ALL login attempts (successful and failed)
model LoginAttempt {
  id              String    @id @default(uuid())
  userId          String?   // null for failed attempts with unknown user
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  email           String    // Email attempted
  ipAddress       String
  country         String?   // Derived from IP
  city            String?
  userAgent       String?

  // Device info
  deviceId        String?   // FK to UserDevice
  device          UserDevice? @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  deviceFingerprint String?

  // Attempt result
  success         Boolean
  failureReason   String?   // INVALID_CREDENTIALS, ACCOUNT_LOCKED, ACCOUNT_INACTIVE, etc.

  // Risk assessment
  riskScore       Int       @default(0) // 0-100
  riskFlags       String[]  // Array of flags: VPN_DETECTED, NEW_DEVICE, NEW_LOCATION, etc.
  isSuspicious    Boolean   @default(false)

  attemptedAt     DateTime  @default(now())

  @@index([email])
  @@index([userId])
  @@index([ipAddress])
  @@index([attemptedAt])
  @@index([success])
  @@index([isSuspicious])
  @@index([email, attemptedAt])
  @@index([ipAddress, attemptedAt])
  // Composite indexes for security queries
  @@index([email, success, attemptedAt])           // checkDistributedAttack
  @@index([userId, success, attemptedAt])          // checkImpossibleTravel
  @@index([ipAddress, userId, success, attemptedAt]) // checkSharedIp
}

// User risk profile - aggregated risk assessment
model UserRiskProfile {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Overall risk score (0-100)
  riskScore       Int       @default(0)
  riskLevel       String    @default("LOW") // LOW, MEDIUM, HIGH, CRITICAL

  // Risk factors
  riskFlags       String[]  // Active risk flags

  // Multi-account detection
  linkedAccounts  String[]  // User IDs of suspected linked accounts
  sharedDevices   String[]  // Device IDs shared with other accounts
  sharedIps       String[]  // IPs shared with other accounts

  // Behavior metrics
  unusualLoginCount     Int @default(0)
  failedLoginCount      Int @default(0)
  suspiciousTradeCount  Int @default(0)
  chargebackCount       Int @default(0)

  // Velocity metrics
  dailyLoginCount       Int @default(0)
  dailyTradeCount       Int @default(0)
  dailyDepositCount     Int @default(0)
  dailyWithdrawalCount  Int @default(0)
  lastVelocityReset     DateTime @default(now())

  // Geographic data
  knownCountries        String[]
  knownIps              String[]
  lastKnownLocation     String?

  // Assessment tracking
  lastAssessedAt        DateTime @default(now())
  assessmentHistory     Json?    // Array of past assessments

  // Manual overrides
  manualRiskOverride    Int?     // Admin can override risk score
  overrideReason        String?
  overrideBy            String?
  overrideAt            DateTime?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@index([riskLevel])
  @@index([riskScore])
}

// Security alerts - notifications for suspicious activity
model SecurityAlert {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  alertType       String    // NEW_DEVICE, NEW_LOCATION, MULTIPLE_FAILED_LOGINS, IMPOSSIBLE_TRAVEL, etc.
  severity        String    // LOW, MEDIUM, HIGH, CRITICAL
  title           String
  description     String
  metadata        Json?     // Additional context

  // Status
  status          String    @default("OPEN") // OPEN, ACKNOWLEDGED, RESOLVED, FALSE_POSITIVE
  resolvedBy      String?
  resolvedAt      DateTime?
  resolution      String?

  // User notification
  userNotified    Boolean   @default(false)
  notifiedAt      DateTime?

  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([alertType])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
  @@index([userId, status])
}

// Known malicious fingerprints/IPs (blocklist)
model SecurityBlocklist {
  id              String    @id @default(uuid())

  type            String    // IP, FINGERPRINT, EMAIL_DOMAIN, COUNTRY
  value           String    // The blocked value
  valueHash       String?   // Hash for fingerprints

  reason          String
  severity        String    // TEMPORARY, PERMANENT

  addedBy         String?   // Admin who added
  addedAt         DateTime  @default(now())
  expiresAt       DateTime? // null = permanent

  // Stats
  blockedAttempts Int       @default(0)
  lastBlockedAt   DateTime?

  @@unique([type, value])
  @@index([type])
  @@index([value])
  @@index([valueHash])
  @@index([expiresAt])
}
